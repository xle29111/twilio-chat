name: PR checks

on:
  pull_request:
    branches:
      - main
      - rt

jobs:
  validate_flows:
    name: config-file
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code from PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Get modified folders from PR compared to base branch
        id: modified
        run: |
          echo "Detecting modified folders by comparing with the base branch..."
          BASE_BRANCH=${{ github.base_ref }}
          echo "Base branch is: $BASE_BRANCH"
          echo "Source branch is: ${{ github.head_ref }}"

          git fetch origin $BASE_BRANCH

          CHANGED_FILES=$(git diff --name-only origin/$BASE_BRANCH...HEAD | grep '^my-project/resources/' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes detected in my-project/resources/"
            echo "MODIFIED_FOLDERS=" >> $GITHUB_ENV
            exit 0
          fi

          MODIFIED_FOLDERS=$(echo "$CHANGED_FILES" | cut -d'/' -f3 | sort -u)
          echo "Modified folders:"
          echo "$MODIFIED_FOLDERS"

          echo "MODIFIED_FOLDERS<<EOF" >> $GITHUB_ENV
          echo "$MODIFIED_FOLDERS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Validate flows_to_deploy.json
        run: |
          if [ -z "$MODIFIED_FOLDERS" ]; then
            echo "No folders to validate."
            exit 0
          fi

          echo "$MODIFIED_FOLDERS" | while IFS= read -r folder; do
            if [ -z "$folder" ]; then continue; fi
            echo "üîç Checking folder: '$folder'"
            jq -e --arg folder "$folder" '.[] | select(.application == $folder and .deploy == true)' flows_to_deploy.json > /dev/null || echo "$folder" >> invalid_folders.txt
          done

          if [ -f invalid_folders.txt ]; then
            echo "‚ùå The following folders are not enabled for deploy:"
            cat invalid_folders.txt | while read f; do
              echo " - $f"
            done
            exit 1
          else
            echo "‚úÖ All modified folders are enabled for deploy."
          fi

  up-to-date:
    name: up-to-date
    runs-on: ubuntu-latest
    needs: validate_flows

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  

      - name: Check if feature branch is up-to-date with base branch
        run: |
          BASE_BRANCH="origin/${{ github.base_ref }}"
          FEATURE_BRANCH="origin/${{ github.head_ref }}"

          echo "Base branch is: $BASE_BRANCH"
          echo "Feature branch is: $FEATURE_BRANCH"

          git fetch origin $BASE_BRANCH

          # Check if the feature branch contains all the commits from the base branch (main or rt)
          if git merge-base --is-ancestor $BASE_BRANCH $FEATURE_BRANCH; then
            echo "‚úÖ The feature branch is up-to-date with $BASE_BRANCH. Merge is allowed."
          else
            echo "‚ùå The feature branch is not up-to-date with $BASE_BRANCH. You need to rebase or merge first."
            exit 1
          fi

  json-lint:
    name: json-lint
    runs-on: ubuntu-latest
    needs: validate_flows

    steps:
      - name: Placeholder for JSON linting
        run: |
          echo "This is a placeholder for the JSON linting check."
          echo "You need to implement the script that lints the JSON files (e.g., flows_to_deploy.json)."
